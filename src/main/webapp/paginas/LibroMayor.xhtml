<ui:composition
        xmlns:ui="jakarta.faces.facelets"
        xmlns:f="jakarta.faces.core"
        template="../WEB-INF/plantilla/default.xhtml"
        xmlns:h="jakarta.faces.html"
        xmlns:p="http://primefaces.org/ui"
        xmlns:ues="jakarta.faces.composite/ues"
        xmlns="http://www.w3.org/1999/xhtml">

    <ui:define name="header">
        <ues:breadcrumb pagina="Libro Mayor"/>
        <h1>#{defaultfrm['page.LibroMayor']}</h1>
    </ui:define>

    <ui:define name="contenido-tabla">
        <h:panelGrid columns="1">
            <h:form id="frmTop">

                <!-- TREE TABLE PARA CONSULTA/MODIFICACIÓN -->
                <p:treeTable id="tabla-top"
                             rendered="#{libroMayorFrm.estado == 'NADA'}"
                             styleClass="tabla-crud"
                             value="#{libroMayorFrm.root}"
                             var="reg"
                             selectionMode="single"
                             selection="#{libroMayorFrm.selectedNode}">
                    <p:ajax event="select"
                            listener="#{libroMayorFrm.onNodeSelect}"
                            update=":libroMayorDetalle :pnlTabla :frmTop:tabla-top"/>

                    <p:column headerText="ID">
                        <h:outputText value="#{reg.id}"/>
                    </p:column>
                    <p:column headerText="Observación">
                        <h:outputText value="#{reg.observacion}"/>
                    </p:column>
                    <p:column headerText="Libro Diario">
                        <h:outputText value="#{reg.idLibroDiario.nombre}" rendered="#{reg.idLibroDiario != null}"/>
                        <h:outputText value="Sin referencia" rendered="#{reg.idLibroDiario == null}" style="color: #999;"/>
                    </p:column>
                </p:treeTable>

                <!-- BOTONES SUPERIORES (NUEVO/CANCELAR) -->
                <ues:botones-top formulario="#{libroMayorFrm}"
                                 actualizar=":libroMayorDetalle :pnlTabla :frmTop:tabla-top :messagesTop"/>

            </h:form>
            <p:messages id="messagesTop" showSummary="true" showDetail="true" autoUpdate="true"/>
        </h:panelGrid>
    </ui:define>

    <ui:define name="contenido-detalle">
        <h:panelGroup id="libroMayorDetalle">
            <p:tabView id="tabLibroMayor"
                       cache="false"
                       dynamic="true"
                       rendered="#{libroMayorFrm.estado != 'NADA'}"
                       activeIndex="0">

                <!-- TAB 1: INFORMACIÓN DEL LIBRO MAYOR -->
                <p:tab id="tabInformacion"
                       closable="false"
                       title="#{libroMayorFrm.estado == 'CREAR' ? 'Crear Libro Mayor' : 'Editar Libro Mayor'}">
                    <h:form id="frmDetalle">

                        <p:panel header="Información del Libro Mayor">
                            <h:panelGrid columns="1" cellpadding="5" style="width: 100%">

                                <!-- ID -->
                                <h:panelGroup style="margin-bottom: 15px;">
                                    <p:outputLabel for="txtIdLibroMayor" value="ID:" style="font-weight: bold; display: block; margin-bottom: 5px;"/>
                                    <p:inputText id="txtIdLibroMayor"
                                                 value="#{libroMayorFrm.registro.id}"
                                                 readonly="true"
                                                 disabled="true"
                                                 style="width: 300px;"
                                                 placeholder="Se generará automáticamente"/>
                                </h:panelGroup>

                                <!-- LIBRO DIARIO -->
                                <h:panelGroup style="margin-bottom: 15px;">
                                    <p:outputLabel for="cmbLibroDiarioLibroMayor"
                                                   value="Libro Diario:"
                                                   style="font-weight: bold; display: block; margin-bottom: 5px;"/>
                                    <h:panelGroup>
                                        <p:selectOneMenu id="cmbLibroDiarioLibroMayor"
                                                         value="#{libroMayorFrm.libroDiarioIdSeleccionado}"
                                                         style="width: 300px;"
                                                         required="#{libroMayorFrm.estado == 'CREAR'}"
                                                         requiredMessage="Seleccione un libro diario para la mayorización">
                                            <f:selectItem itemLabel="-- Seleccione un Libro Diario --" itemValue="#{null}"/>
                                            <f:selectItems value="#{libroMayorFrm.librosDiariosDisponibles}"
                                                           var="libroDiario"
                                                           itemLabel="#{libroDiario.nombre} (ID: #{libroDiario.id})"
                                                           itemValue="#{libroDiario.id}"/>
                                            <p:ajax event="change"
                                                    listener="#{libroMayorFrm.onLibroDiarioSelect}"
                                                    update=":frmDetalle:txtObservacionLibroMayor :messagesTop"/>
                                        </p:selectOneMenu>
                                        <p:message for="cmbLibroDiarioLibroMayor" display="icon"/>
                                    </h:panelGroup>

                                    <!-- MENSAJE INFORMATIVO SOLO EN MODO CREACIÓN -->
                                    <h:panelGroup rendered="#{libroMayorFrm.estado == 'CREAR' and libroMayorFrm.libroDiarioIdSeleccionado != null}">
                                        <p:message severity="info"
                                                   summary="Libro diario seleccionado: #{libroMayorFrm.libroDiarioSeleccionado.nombre}"
                                                   style="margin-top: 5px; display: block;"/>
                                    </h:panelGroup>
                                </h:panelGroup>

                                <!-- OBSERVACIÓN -->
                                <h:panelGroup style="margin-bottom: 15px;">
                                    <p:outputLabel for="txtObservacionLibroMayor"
                                                   value="Observación *:"
                                                   style="font-weight: bold; display: block; margin-bottom: 5px;"/>
                                    <h:panelGroup>
                                        <p:inputTextarea id="txtObservacionLibroMayor"
                                                         value="#{libroMayorFrm.registro.observacion}"
                                                         required="true"
                                                         requiredMessage="La observación es obligatoria"
                                                         rows="4"
                                                         style="width: 300px;"
                                                         placeholder="Ingrese la observación del libro mayor"
                                                         maxlength="500"/>
                                        <p:message for="txtObservacionLibroMayor" display="icon"/>
                                    </h:panelGroup>

                                    <!-- SUGERENCIA DE OBSERVACIÓN AUTOMÁTICA -->
                                    <h:panelGroup rendered="#{libroMayorFrm.estado == 'CREAR' and libroMayorFrm.libroDiarioIdSeleccionado != null and (libroMayorFrm.registro.observacion == null or libroMayorFrm.registro.observacion.isBlank())}">
                                        <p:message severity="info"
                                                   summary="Sugerencia: La observación se puede generar automáticamente basada en el libro diario seleccionado"
                                                   style="margin-top: 5px; display: block; font-style: italic;"/>
                                    </h:panelGroup>
                                </h:panelGroup>

                            </h:panelGrid>
                        </p:panel>

                        <!-- BOTONES CRUD MEJOR ALINEADOS -->
                        <h:panelGrid columns="3" style="margin-top: 20px; text-align: center; width: 100%;">
                            <!-- En modo CREAR: Botón normal de crear -->
                            <p:commandButton value="#{defaultfrm['defaultfrm.create']}"
                                              action="#{libroMayorFrm.crearLibroMayor}"
                                               icon="pi pi-save"
                                               update=":libroMayorDetalle :pnlTabla :frmTop:tabla-top :messagesTop"
                                              process="@form"
                                              rendered="#{libroMayorFrm.estado == 'CREAR'}"
                                              styleClass="ui-button-primary"
                                              oncomplete="if(!args.validationFailed) {
                                                  // Forzar actualización del tabView para habilitar el tab 2
                                                  PF('tabLibroMayor').loadTabs();
                                              }"/>

                            <!-- En modo MODIFICAR: Botón guardar -->
                            <p:commandButton value="#{defaultfrm['boton.guardar']}"
                                              action="#{libroMayorFrm.guardarCambios}"
                                               icon="pi pi-check"
                                               update=":libroMayorDetalle :pnlTabla :frmTop:tabla-top :messagesTop"
                                              process="@form"
                                              rendered="#{libroMayorFrm.estado == 'MODIFICAR'}"
                                              styleClass="ui-button-success"/>

                            <!-- Botón eliminar (solo en modificación) -->
                            <p:commandButton value="#{defaultfrm['defaultfrm.delete']}"
                                              action="#{libroMayorFrm.eliminarLibroMayor}"
                                               icon="pi pi-trash"
                                               update=":libroMayorDetalle :pnlTabla :frmTop:tabla-top :messagesTop"
                                               process="@this"
                                              rendered="#{libroMayorFrm.estado == 'MODIFICAR' and libroMayorFrm.registro.id != null}"
                                               styleClass="ui-button-danger"
                                               onclick="return confirm('¿Está seguro de que desea eliminar este Libro Mayor?')"/>
                        </h:panelGrid>

                    </h:form>
                </p:tab>
                <!-- TAB 2: MAYORIZACIÓN -->
                <p:tab id="tabMayorizacion"
                       title="Mayorización"
                       disabled="#{libroMayorFrm.estado != 'MODIFICAR' or libroMayorFrm.registro.id == null}">
                    <h:form id="frmMayorizacion">
                        <p:panel header="Detalles de Mayorización">

                            <!-- BOTONES SUPERIORES PARA DETALLES -->
                            <h:panelGrid columns="2" style="margin-bottom: 20px; width: 100%;">
                                <p:commandButton value="#{defaultfrm['boton.buscar']}"
                                                 action="#{libroMayorFrm.prepararNuevoDetalle}"
                                                 icon="pi pi-search"
                                                 update="@form"
                                                 process="@this"
                                                 oncomplete="PF('dlgDetalle').show()"
                                                 styleClass="ui-button-primary"/>

                                <p:outputLabel value="Total detalles: #{libroMayorFrm.detallesCount}"
                                               style="font-weight: bold; text-align: right;"/>
                            </h:panelGrid>

                            <!-- TABLA DE DETALLES -->
                            <p:dataTable id="tblDetalles"
                                         value="#{libroMayorFrm.detallesLibroMayor}"
                                         var="detalle"
                                         emptyMessage="No hay detalles de mayorización"
                                         styleClass="tabla-crud"
                                         paginator="true"
                                         rows="10"
                                         rowKey="#{detalle.id}">

                                <p:column headerText="ID Detalle" width="150">
                                    <h:outputText value="#{detalle.id}"/>
                                </p:column>

                                <p:column headerText="Cuenta Mayorizada" width="300">
                                    <h:outputText value="#{detalle.nombreCuenta != null ? detalle.nombreCuenta : 'Cuenta ID: ' + detalle.id.toString().substring(0,8)}"/>
                                </p:column>

                                <p:column headerText="Saldo" width="120">
                                    <h:outputText value="#{detalle.saldo}">
                                        <f:convertNumber type="currency" currencySymbol="$" minFractionDigits="2"/>
                                    </h:outputText>
                                </p:column>

                                <p:column headerText="Acciones" width="150">
                                    <h:panelGroup style="display: flex; gap: 5px; justify-content: center;">
                                        <p:commandButton icon="pi pi-trash"
                                                         title="Eliminar"
                                                         styleClass="ui-button-danger"
                                                         update="tblDetalles :messagesTop"
                                                         process="@this"
                                                         action="#{libroMayorFrm.eliminarDetalle}"
                                                         onclick="return confirm('¿Eliminar este detalle?')">
                                            <f:setPropertyActionListener target="#{libroMayorFrm.detalleSeleccionado}" value="#{detalle}" />
                                        </p:commandButton>
                                    </h:panelGroup>
                                </p:column>
                            </p:dataTable>

                        </p:panel>

                    </h:form>
                </p:tab>

            </p:tabView>

            <!-- DIÁLOGO PARA SELECCIONAR CUENTA CONTABLE -->
            <p:dialog id="dlgDetalle"
                      header="Crear Mayorización - Seleccionar Cuenta Contable"
                      widgetVar="dlgDetalle"
                      modal="true"
                      resizable="false"
                      width="900"
                      height="600"
                      closable="true"
                      onShow="ocultarSeccionesDetalle()">

                <h:form id="frmDialogo">
                    <h:panelGrid columns="1" style="width: 100%;" cellpadding="10">

                        <!-- BÚSQUEDA DE CUENTA CONTABLE -->
                        <h:panelGrid columns="3" style="width: 100%; margin-bottom: 20px;">
                            <p:outputLabel value="Buscar Cuenta Contable:" style="font-weight: bold;"/>
                            <p:inputText id="filtroCuentaDialogo"
                                         value="#{libroMayorFrm.filtroCuenta}"
                                         placeholder="Ingrese nombre de cuenta (ej: ACTIVOS CORRIENTES)"
                                         style="width: 300px;">
                                <p:ajax event="keyup"
                                        listener="#{libroMayorFrm.buscarCuentas}"
                                        update="tblCuentas"
                                        delay="500"/>
                            </p:inputText>
                            <p:commandButton value="#{defaultfrm['boton.buscar']}"
                                             action="#{libroMayorFrm.buscarCuentas}"
                                             update="tblCuentas"
                                             styleClass="ui-button-primary"/>
                        </h:panelGrid>

                        <!-- TABLA DE CUENTAS CONTABLES -->
                        <p:dataTable id="tblCuentas"
                                     value="#{libroMayorFrm.cuentasContables}"
                                     var="cuenta"
                                     emptyMessage="No se encontraron cuentas contables"
                                     styleClass="tabla-crud"
                                     paginator="true"
                                     rows="5"
                                     selection="#{libroMayorFrm.cuentaSeleccionadaObj}"
                                     selectionMode="single"
                                     rowKey="#{cuenta.codigo}">

                            <p:column headerText="Código" width="100">
                                <h:outputText value="#{cuenta.codigo}"/>
                            </p:column>

                            <p:column headerText="Nombre" width="300">
                                <h:outputText value="#{cuenta.nombre}"/>
                            </p:column>

                            <p:column headerText="Saldo" width="150">
                                <h:outputText value="#{cuenta.saldo}">
                                    <f:convertNumber type="currency" currencySymbol="$" minFractionDigits="2"/>
                                </h:outputText>
                            </p:column>

                            <p:column headerText="Seleccionar" width="100">
                                <p:commandButton value="#{defaultfrm['boton.seleccionar']}"
                                                 action="#{libroMayorFrm.prepararDetallesCuenta}"
                                                 update=":frmDialogo:pnlCuentaSeleccionada :frmDialogo:pnlDetallesCuenta :frmDialogo:pnlCrearMayorizacion"
                                                 process="@this"
                                                 oncomplete="mostrarSeccionesDetalle()">
                                    <f:setPropertyActionListener target="#{libroMayorFrm.cuentaSeleccionadaObj}" value="#{cuenta}" />
                                </p:commandButton>
                            </p:column>

                            <p:ajax event="rowSelect"
                                    listener="#{libroMayorFrm.onCuentaSelect}"
                                    update=":frmDialogo:pnlCuentaSeleccionada :frmDialogo:pnlDetallesCuenta :frmDialogo:pnlCrearMayorizacion"
                                    oncomplete="mostrarSeccionesDetalle()"/>
                        </p:dataTable>

                        <!-- SECCIÓN DE CUENTA SELECCIONADA -->
                        <h:panelGroup id="pnlCuentaSeleccionada" style="display: none; width: 100%; margin: 20px 0;">
                            <h:panelGrid columns="2" style="width: 100%;">
                                <p:outputLabel value="Cuenta Seleccionada:" style="font-weight: bold;"/>
                                <p:outputLabel value="#{libroMayorFrm.cuentaSeleccionada}"
                                               style="font-weight: bold; color: #2E86AB; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"/>
                            </h:panelGrid>
                        </h:panelGroup>

                        <!-- SECCIÓN DE DETALLES DE MOVIMIENTOS -->
                        <h:panelGroup id="pnlDetallesCuenta" style="display: none; width: 100%;">
                            <p:panel header="Movimientos de la Cuenta" style="margin-bottom: 20px;">
                                <p:dataTable value="#{libroMayorFrm.detallesCuentaContable}"
                                             var="movimiento"
                                             emptyMessage="No hay movimientos para esta cuenta"
                                             styleClass="tabla-crud"
                                             paginator="true"
                                             rows="5">

                                    <p:column headerText="Fecha" width="100">
                                        <h:outputText value="#{movimiento.fecha}">
                                            <f:convertDateTime pattern="dd/MM/yyyy"/>
                                        </h:outputText>
                                    </p:column>

                                    <p:column headerText="Concepto" width="200">
                                        <h:outputText value="#{movimiento.concepto}"/>
                                    </p:column>

                                    <p:column headerText="Partida #" width="100">
                                        <h:outputText value="#{movimiento.numeroPartida}"/>
                                    </p:column>

                                    <p:column headerText="Debe" width="100">
                                        <h:outputText value="#{movimiento.montoDebe}">
                                            <f:convertNumber type="currency" currencySymbol="$" minFractionDigits="2"/>
                                        </h:outputText>
                                    </p:column>

                                    <p:column headerText="Haber" width="100">
                                        <h:outputText value="#{movimiento.montoHaber}">
                                            <f:convertNumber type="currency" currencySymbol="$" minFractionDigits="2"/>
                                        </h:outputText>
                                    </p:column>

                                    <p:column headerText="Saldo Parcial" width="100">
                                        <h:outputText value="#{movimiento.saldoParcial}">
                                            <f:convertNumber type="currency" currencySymbol="$" minFractionDigits="2"/>
                                        </h:outputText>
                                    </p:column>
                                </p:dataTable>
                            </p:panel>
                        </h:panelGroup>

                        <!-- SECCIÓN PARA CREAR MAYORIZACIÓN - CORREGIDA -->
                        <h:panelGroup id="pnlCrearMayorizacion" style="display: none; width: 100%;">
                            <h:panelGrid columns="3" style="width: 100%; margin-top: 20px;">
                                <p:outputLabel value="Saldo Final de Mayorización:" style="font-weight: bold;"/>
                                <p:outputLabel value="#{libroMayorFrm.saldoFinal}"
                                               style="font-weight: bold; color: #2E86AB; text-align: right; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <f:convertNumber type="currency" currencySymbol="$" minFractionDigits="2"/>
                                </p:outputLabel>
                                <p:commandButton value="#{defaultfrm['boton.crear'] != null ? defaultfrm['boton.crear'] : 'Crear'}"
                                                 action="#{libroMayorFrm.crearMayorizacion}"
                                                 icon="pi pi-check"
                                                 update=":frmMayorizacion:tblDetalles :messagesTop"
                                                 process="@this"
                                                 oncomplete="if(!args.validationFailed) {
                                                     PF('dlgDetalle').hide();
                                                     ocultarSeccionesDetalle();
                                                     PrimeFaces.info('Mayorización creada exitosamente.');
                                                 }"
                                                 styleClass="ui-button-success"/>
                            </h:panelGrid>
                        </h:panelGroup>

                        <!-- BOTÓN CANCELAR DEL DIÁLOGO -->
                        <h:panelGroup style="text-align: center; margin-top: 20px;">
                            <p:commandButton value="Cancelar"
                                             icon="pi pi-times"
                                             action="#{libroMayorFrm.cerrarDialogo('dlgDetalle')}"
                                             process="@none"
                                             styleClass="ui-button-secondary"/>
                        </h:panelGroup>

                    </h:panelGrid>
                </h:form>

                <!-- SCRIPTS PARA CONTROLAR VISIBILIDAD -->
                <script type="text/javascript">
                    function mostrarSeccionesDetalle() {
                        console.log('Mostrando secciones de detalle...');
                        var seccionCuenta = document.getElementById('frmDialogo:pnlCuentaSeleccionada');
                        var seccionDetalles = document.getElementById('frmDialogo:pnlDetallesCuenta');
                        var seccionCrear = document.getElementById('frmDialogo:pnlCrearMayorizacion');

                        if (seccionCuenta) seccionCuenta.style.display = 'block';
                        if (seccionDetalles) seccionDetalles.style.display = 'block';
                        if (seccionCrear) seccionCrear.style.display = 'block';
                    }

                    function ocultarSeccionesDetalle() {
                        console.log('Ocultando secciones de detalle...');
                        var seccionCuenta = document.getElementById('frmDialogo:pnlCuentaSeleccionada');
                        var seccionDetalles = document.getElementById('frmDialogo:pnlDetallesCuenta');
                        var seccionCrear = document.getElementById('frmDialogo:pnlCrearMayorizacion');

                        if (seccionCuenta) seccionCuenta.style.display = 'none';
                        if (seccionDetalles) seccionDetalles.style.display = 'none';
                        if (seccionCrear) seccionCrear.style.display = 'none';
                    }
                </script>

            </p:dialog>

        </h:panelGroup>
    </ui:define>

</ui:composition>
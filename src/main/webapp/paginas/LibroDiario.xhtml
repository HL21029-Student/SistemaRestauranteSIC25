<ui:composition
        xmlns:ui="jakarta.faces.facelets"
        xmlns:f="jakarta.faces.core"
        template="../WEB-INF/plantilla/default.xhtml"
        xmlns:h="jakarta.faces.html"
        xmlns:p="http://primefaces.org/ui"
        xmlns:ues="jakarta.faces.composite/ues"
        xmlns="http://www.w3.org/1999/xhtml"

>
    <ui:define name="header">
        <ues:breadcrumb pagina="Libro Diario"/>
        <h1>#{defaultfrm['page.LibroDiario']}</h1>
    </ui:define>

    <ui:define name="contenido-tabla">
        <h:panelGrid>
            <h:form id="frmTop">
                <p:treeTable id="tabla-top"
                             rendered="#{libroDiarioFrm.estado == 'NADA'}"
                             styleClass="tabla-crud"
                             value="#{libroDiarioFrm.root}" var="reg"
                             selectionMode="single"
                             selection="#{libroDiarioFrm.selectedNode}">
                    <p:ajax event="select"
                            listener="#{libroDiarioFrm.onNodeSelect}"
                            update=":pnlDetalle :pnlTabla"/>

                    <p:column headerText="ID">
                        <h:outputText value="#{reg.id}"/>
                    </p:column>
                    <p:column headerText="Nombre">
                        <h:outputText value="#{reg.nombre}"/>
                    </p:column>
                    <p:column headerText="Comentario">
                        <h:outputText value="#{reg.comentario}"/>
                    </p:column>
                </p:treeTable>

                <ues:botones-top formulario="#{libroDiarioFrm}" actualizar=":pnlDetalle :pnlTabla"/>

            </h:form>
            <p:messages showSummary="true" showDetail="true"/>
        </h:panelGrid>
    </ui:define>

    <ui:define name="contenido-detalle">

        <p:tabView id="tabLibroDiario" cache="false" dynamic="true" rendered="#{libroDiarioFrm.estado != 'NADA'}">

            <p:tab closable="false" title="Información General">
                <h:panelGrid>
                    <h:form id="frmCrear">
                        <h:panelGrid>

                            <p:outputLabel for="txtId" value="ID:"/>
                            <p:inputText id="txtId" value="#{libroDiarioFrm.registro.id}" readonly="true"
                                         disabled="true"/>
                            <p:outputLabel for="txtNombre" value="Nombre:"/>
                            <p:inputText id="txtNombre" value="#{libroDiarioFrm.registro.nombre}"/>
                            <p:outputLabel for="txtComentario" value="Comentario:"/>
                            <p:inputText id="txtComentario" value="#{libroDiarioFrm.registro.comentario}"/>

                            <p:outputLabel for="cmbAjuste" value="Referencia Ajuste:"/>
                            <p:selectOneMenu id="cmbAjuste"
                                             value="#{libroDiarioFrm.registro.diarioAjustePadre}"
                                             converter="libroDiarioConverter">
                                <f:selectItem itemLabel="-- Ninguno (Tipo Raíz) --" itemValue="#{null}"/>
                                <f:selectItems value="#{libroDiarioFrm.libroDiarioDisponibles}"
                                               var="tpfrm"
                                               itemLabel="#{tpfrm.nombre}"
                                               itemValue="#{tpfrm}"
                                />
                            </p:selectOneMenu>

                        </h:panelGrid>
                        <ues:botones-crud formulario="#{libroDiarioFrm}"
                                          actualizar=":pnlDetalle :pnlTabla :tabLibroDiario"/>
                    </h:form>
                </h:panelGrid>
            </p:tab>

            <p:tab closable="false" title="Asientos Contables" disabled="#{libroDiarioFrm.estado != 'MODIFICAR'}">
                <h:panelGrid>
                    <h:panelGroup id="pnlAsientosContables">
                        <h2>#{libroDiarioFrm.registro.nombre}</h2>
                        <h:form id="frmAsientosContables">
                            <p:dataTable value="#{libroDiarioFrm.detalleLibroDiarioFrm.modelo}" var="reg"
                                         paginator="true"
                                         paginatorPosition="bottom"
                                         lazy="true"
                                         selection="#{libroDiarioFrm.detalleLibroDiarioFrm.registro}"
                                         selectionMode="single"
                                         rows="#{libroDiarioFrm.detalleLibroDiarioFrm.pageSize}"
                                         rendered="#{libroDiarioFrm.detalleLibroDiarioFrm.estado == 'NADA'}">

                                <p:ajax event="rowSelect"
                                        process="@this"
                                        listener="#{libroDiarioFrm.detalleLibroDiarioFrm.seleccionarRegistro}"
                                        update=":tabLibroDiario:pnlAsientosContables :tabLibroDiario:pnlDetalleAsientosContables"/>

                                <p:column headerText="ID">
                                    <h:outputText value="#{reg.id}"/>
                                </p:column>

                                <p:column headerText="Fecha">
                                    <h:outputText value="#{reg.fecha}">
                                        <f:convertDateTime pattern="dd/MM/yyyy"/>
                                    </h:outputText>
                                </p:column>

                                <p:column headerText="Codigo">
                                    <h:outputText value="#{reg.idCuentaContable.codigo}"/>
                                </p:column>
                                <p:column headerText="Nombre">
                                    <h:outputText value="#{reg.idCuentaContable.nombre}"/>
                                </p:column>

                                <p:column headerText="Numero partida">
                                    <h:outputText value="#{reg.numeroPartida}"/>
                                </p:column>

                                <p:column headerText="Concepto">
                                    <h:outputText value="#{reg.concepto}"/>
                                </p:column>

                                <p:column headerText="Parcial">
                                    <h:outputText value="#{reg.parcial}">
                                        <f:convertNumber type="currency" currencySymbol="$"/>
                                    </h:outputText>
                                </p:column>

                                <p:column headerText="Debe">
                                    <h:outputText value="#{reg.debe}">
                                    </h:outputText>
                                </p:column>

                                <p:column headerText="Monto Total">
                                    <h:outputText value="#{reg.monto}">
                                        <f:convertNumber type="currency" currencySymbol="$"/>
                                    </h:outputText>
                                </p:column>

                            </p:dataTable>

                            <ues:botones-top formulario="#{libroDiarioFrm.detalleLibroDiarioFrm}"
                                             actualizar=":tabLibroDiario:pnlAsientosContables :tabLibroDiario:pnlDetalleAsientosContables"/>
                        </h:form>
                    </h:panelGroup>

                    <h:panelGroup id="pnlDetalleAsientosContables">
                        <!--Agregar autoUpdate para mostrar mensajes -->
                        <p:growl id="growlDetalleAsientosContables" showDetail="true" autoUpdate="true"/>
                        <p:growl id="growl-stickyTablaAsientosContables" for="sticky-key" showDetail="true"
                                 sticky="true" autoUpdate="true"/>

                        <h:panelGrid rendered="#{libroDiarioFrm.detalleLibroDiarioFrm.estado !='NADA'}">
                            <h:form id="frmDetalleAsientosContables">
                                <h:panelGrid columns="2">
                                    <p:outputLabel for="txtIdDetalleAsientosContables" value="ID:"/>
                                    <p:inputText id="txtIdDetalleAsientosContables"
                                                 value="#{libroDiarioFrm.detalleLibroDiarioFrm.registro.id}"
                                                 readonly="true" disabled="true"/>
                                    <p:outputLabel for="txtFechaDetalleAsientosContables" value="Fecha:"/>
                                    <p:calendar id="txtFechaDetalleAsientosContables"
                                                value="#{libroDiarioFrm.detalleLibroDiarioFrm.registro.fecha}"
                                                pattern="dd/MM/yyyy"/>

                                    <p:outputLabel for="txtCuentaContableSeleccionada" value="Nombre Cuenta:"/>
                                    <h:panelGroup>
                                        <h:panelGrid columns="2">
                                            <!--Usar outputLabel en lugar de inputText disabled para mejor visualización -->
                                            <p:outputLabel id="txtCuentaContableSeleccionada"
                                                           value="#{libroDiarioFrm.detalleLibroDiarioFrm.registro.idCuentaContable.nombre}"
                                                           style="font-weight: bold; padding: 5px; border: 1px solid #ccc; background: #f9f9f9; display: block; min-width: 300px;"/>
                                            <p:commandButton type="button"
                                                             onclick="PF('dlgBuscarCuentaContable').show();"
                                                             value="Buscar Cuenta"
                                                             icon="pi pi-search"
                                            />
                                        </h:panelGrid>
                                    </h:panelGroup>

                                    <p:outputLabel for="txtNumeroPartidaDetalleAsientosContables"
                                                   value="Número de Partida:"/>
                                    <p:inputText id="txtNumeroPartidaDetalleAsientosContables"
                                                 value="#{libroDiarioFrm.detalleLibroDiarioFrm.registro.numeroPartida}"/>

                                    <p:outputLabel for="txtConceptoDetalleAsientosContables" value="Concepto:"/>
                                    <p:inputText id="txtConceptoDetalleAsientosContables"
                                                 value="#{libroDiarioFrm.detalleLibroDiarioFrm.registro.concepto}"/>

                                    <p:outputLabel for="chkDireccionAsientosContables" value="Direccion de la cuenta:"/>
                                    <h:panelGroup>
                                        <p:selectOneRadio id="chkDireccionAsientosContables"
                                                          value="#{libroDiarioFrm.detalleLibroDiarioFrm.registro.debe}">
                                            <f:selectItem itemLabel="Debe" itemValue="#{true}"/>
                                            <f:selectItem itemLabel="Haber" itemValue="#{false}"/>
                                        </p:selectOneRadio>
                                    </h:panelGroup>

                                    <p:outputLabel for="txtMontoDetalleAsientosContables" value="Monto Total:"/>
                                    <p:inputText id="txtMontoDetalleAsientosContables"
                                                 value="#{libroDiarioFrm.detalleLibroDiarioFrm.registro.monto}"/>

                                </h:panelGrid>

                                <ues:botones-crud formulario="#{libroDiarioFrm.detalleLibroDiarioFrm}"
                                                  actualizar=":tabLibroDiario:pnlAsientosContables :tabLibroDiario:pnlDetalleAsientosContables"/>

                            </h:form>
                        </h:panelGrid>
                    </h:panelGroup>

                </h:panelGrid>
            </p:tab>

        </p:tabView>
    </ui:define>

    <ui:define name="extra">
        <!--Diálogo simplificado sin PanelGrid problemático -->
        <p:dialog id="dlgBuscarCuentaContable" widgetVar="dlgBuscarCuentaContable" modal="true" closable="true" header="Buscar Cuenta Contable">
            <h:form id="frmDlgBuscarCuentaContable">
                <p:panelGrid columns="2" style="width: 100%; margin-bottom: 10px;">
                    <p:outputLabel value="Cuenta contable:" for="acCuentaContableBusqueda"/>
                    <p:autoComplete id="acCuentaContableBusqueda"
                                    completeMethod="#{libroDiarioFrm.detalleLibroDiarioFrm.buscarCuentaContablePorNombre}"
                                    value="#{libroDiarioFrm.detalleLibroDiarioFrm.cuentaContableTemporal}"
                                    var="cuenta"
                                    converter="cuentaContableConverter"
                                    itemLabel="#{cuenta.nombre}"
                                    itemValue="#{cuenta}"
                                    forceSelection="true"
                                    dropdown="true"
                                    size="40"
                                    placeholder="Ingrese nombre de cuenta"
                                    emptyMessage="No se encontraron cuentas"/>
                </p:panelGrid>

                <p:commandButton value="#{defaultfrm['boton.seleccionar']}"
                                 icon="pi pi-check"
                                 process="@form"
                                 action="#{libroDiarioFrm.detalleLibroDiarioFrm.seleccionarCuentaContable}"
                                 update=":tabLibroDiario:frmDetalleAsientosContables :tabLibroDiario:growlDetalleAsientosContables"
                                 oncomplete="PF('dlgBuscarCuentaContable').hide();"
                                 style="width: 100%;"/>
            </h:form>
        </p:dialog>

    </ui:define>

</ui:composition>